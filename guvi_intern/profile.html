<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Profile</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    /* page style aligned with sign-in / signup (updated to match provided screenshot) */
    body {
      background: radial-gradient(1200px 600px at 6% 10%, rgba(11,22,36,0.95), rgba(6,10,16,0.97)) fixed;
      color: #e6eef6;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:40px 14px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    /* center, compact, sign-in style card */
    .profile-card {
      width: 660px;
      max-width: calc(100% - 50px);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 16px;
      padding: 28px 32px;
      box-shadow: 0 40px 120px rgba(2,6,23,0.7), inset 0 1px 0 rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.03);
    }
    .avatar { border:2px solid rgba(255,255,255,0.06); box-shadow: 0 8px 40px rgba(0,0,0,0.6); border-radius: 12px; }
    h3 { margin:0 0 6px; color: #f4f7fb; font-weight:700; }
    .small-muted { color: rgba(230,238,246,0.65); }

    /* floating field matching signup style, dark variant */
    .field { position: relative; margin-bottom: 12px; display:block; }
    .field .input {
      width:100%;
      padding: 14px 12px 8px;
      box-sizing:border-box;
      border-radius:10px;
      border: 1px solid rgba(255,255,255,0.04);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));
      color: #e8f1ff;
      outline: none;
    }
    .field .flabel {
      position: absolute; left:12px; top:12px; pointer-events:none;
      transition: transform .16s, top .16s, color .16s;
      transform-origin: left center;
      color: rgba(230,238,246,0.7);
      font-size:0.9rem;
      z-index:2;
      padding:0 6px;
      background: linear-gradient(90deg, rgba(0,0,0,0.0), rgba(0,0,0,0));
    }
    .field.filled .flabel, .field .input:focus + .flabel {
      transform: translateY(-58%) scale(.86);
      top:8px;
      color: #ffd86b;
    }
    .field .underline { height:2px; margin-top:8px; background:transparent; border-radius:8px; transition: background .12s; display:block; }
    .field .input:focus ~ .underline { background: rgba(255,216,107,0.14); }
    .input.is-invalid { border-color: rgba(220,53,69,0.9) !important; box-shadow: 0 0 0 4px rgba(220,53,69,0.06); }

    /* golden CTA button (matches sign-in) */
    .btn-cta {
      background: linear-gradient(90deg, #d6a83b, #ffd86b);
      color: #0b0810;
      border: none;
      padding: 12px 18px;
      border-radius: 10px;
      box-shadow: 0 10px 28px rgba(214,168,59,0.12);
      font-weight:700;
    }
    /* large primary look used for the main action where needed */
    .btn-cta.primary-wide { width:100%; padding:14px 18px; font-size:1rem; border-radius:12px; }
    .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.06); color: rgba(230,238,246,0.9); }

    /* progress + activity adjustments for dark background */
    .profile-progress { background: rgba(255,255,255,0.03); }
    .profile-progress > .bar { box-shadow:none; background: linear-gradient(90deg, rgba(255,216,107,0.95), rgba(255,205,77,0.85)); }
    .progress-value { color: #ffd86b; }

    .activity-entry { background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); border: 1px solid rgba(255,255,255,0.03); color: rgba(230,238,246,0.85); font-size:0.92rem; }
    .toast { background: rgba(10,14,20,0.9); color: #fff; }
  </style>
</head>
<body>
  <div class="profile-card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:18px; margin-bottom:8px;">
      <div style="display:flex; gap:12px; align-items:center;">
        <img id="p_avatar" class="avatar" src="" alt="Avatar">
        <div>
          <h3 id="p_name">User</h3>
          <div class="small-muted" id="p_email">email@example.com</div>
          <div class="small-muted" id="p_lastlogin">Last login: -</div>
        </div>
      </div>
      <div style="min-width:220px; text-align:right;">
        <!-- big primary action visually aligned with sign-in style -->
        <button id="logoutBtnTop" class="btn btn-ghost" style="margin-bottom:8px; display:block;">Sign out</button>
        <button id="editBtnTop" class="btn btn-cta primary-wide hidden">Save changes</button>
      </div>
    </div>

    <!-- Edit fields -->
    <div class="profile-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
      <div class="field">
        <input id="input_name" class="input" type="text" />
        <label class="flabel">Name</label>
        <div class="underline"></div>
      </div>
      <div class="field">
        <input id="input_phone" class="input" type="text" />
        <label class="flabel">Phone</label>
        <div class="underline"></div>
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px; align-items:center; justify-content:space-between;">
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="editBtn" class="btn btn-cta">Edit</button>
        <button id="uploadBtn" class="btn btn-ghost">Change avatar</button>
        <button id="removeAvatarBtn" class="btn btn-outline-danger hidden" title="Remove avatar">Remove avatar</button>
        <input id="avatarInput" type="file" accept="image/*" class="hidden" />
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="logoutBtn" class="btn btn-ghost">Logout</button>
        <button id="logoutBtnMain" class="btn btn-cta">Sign out</button>
      </div>
    </div>

    <!-- Profile completion progress -->
    <div class="progress-wrap">
      <div class="profile-progress" title="Profile completeness">
        <div id="p_progress" class="bar"></div>
      </div>
      <div id="p_progress_val" class="progress-value">0%</div>
    </div>

    <!-- activity feed -->
    <hr>
    <div style="font-weight:600; font-size:0.95rem; margin-bottom:8px;">Activity</div>
    <div id="activityFeed" class="activity-feed"></div>
    <hr>

    <!-- Change password -->
    <div>
      <button id="toggleChangePw" class="link-like">Change password</button>
      <div id="changePwBox" class="hidden" style="margin-top:8px;">
        <input id="currentPw" class="form-control" type="password" placeholder="Current password" />
        <input id="newPw" class="form-control" type="password" placeholder="New password (min 6 chars)" style="margin-top:8px;" />
        <input id="confirmPw" class="form-control" type="password" placeholder="Confirm new password" style="margin-top:8px;" />
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="changePwBtn" class="btn btn-success">Save password</button>
          <button id="cancelChangePw" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <hr>

    <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
      <div class="small-muted">Account actions</div>
      <button id="deleteBtn" class="btn danger">Delete account</button>
    </div>
  </div>

  <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <script>
  (function(){
    // ensure floating styles work for rendered inputs
    function wireFloating(el){
      if (!el) return;
      function toggle(){ var parent = el.closest('.field'); if(!parent) return; if (el.value && el.value.trim() !== '') parent.classList.add('filled'); else parent.classList.remove('filled'); }
      el.addEventListener('input', toggle); el.addEventListener('blur', toggle); toggle();
    }
    // small helpers: toasts and activity
    function showToast(text, timeout){ timeout = timeout || 2800; var el = document.createElement('div'); el.className = 'toast'; el.textContent = text; toastWrap.appendChild(el); // show animation
      requestAnimationFrame(function(){ el.classList.add('show'); });
      setTimeout(function(){ el.classList.remove('show'); setTimeout(function(){ el.remove(); }, 300); }, timeout);
    }
    function pushActivity(msg){
      if (!current || !current.email) return;
      var key = 'activity_' + current.email.toLowerCase();
      var arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.unshift({ txt: msg, t: new Date().toISOString() });
      if (arr.length>50) arr.length = 50;
      localStorage.setItem(key, JSON.stringify(arr));
      renderActivity();
    }
    function renderActivity(){
      var key = current && current.email ? 'activity_' + current.email.toLowerCase() : null;
      var arr = key ? JSON.parse(localStorage.getItem(key) || '[]') : [];
      activityFeed.innerHTML = '';
      arr.forEach(function(a){ var e = document.createElement('div'); e.className = 'activity-entry'; e.textContent = a.txt + ' Â· ' + new Date(a.t).toLocaleString(); activityFeed.appendChild(e); });
    }
    // profile completeness calculation
    function computeCompletion(rec, userRec){
      rec = rec || {};
      userRec = userRec || {};
      var score = 0;
      if (rec.name && rec.name.trim()) score += 20;
      if (rec.email && rec.email.trim()) score += 20;
      if (rec.phone && rec.phone.trim()) score += 20;
      if (rec.avatar && rec.avatar.indexOf('placeholder')===-1) score += 20;
      // treat having a password OR known lastLogin as completion
      if ((userRec && userRec.password) || rec.lastLogin) score += 20;
      return Math.min(100, Math.max(0, score));
    }
    function setProgress(value){
      p_progress.style.width = (value||0) + '%';
      p_progress_val.textContent = (value||0) + '%';
    }

    function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
    function getUsers(){ try{ return JSON.parse(localStorage.getItem('users')||'[]'); } catch(e){ return []; } }
    function saveUsers(u){ localStorage.setItem('users', JSON.stringify(u)); }
    function getCurrent(){ try{ return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch(e){ return null; } }
    function setCurrent(u){ localStorage.setItem('currentUser', JSON.stringify(u)); }

    ready(function(){
      // new small element references
      var p_progress = document.getElementById('p_progress');
      var p_progress_val = document.getElementById('p_progress_val');
      var toastWrap = document.getElementById('toastWrap');
      var activityFeed = document.getElementById('activityFeed');
      var avatarDrop = document.getElementById('avatarDrop');

      var p_avatar = document.getElementById('p_avatar');
      var p_name = document.getElementById('p_name');
      var p_email = document.getElementById('p_email');
      var p_lastlogin = document.getElementById('p_lastlogin');
      var input_name = document.getElementById('input_name');
      var input_phone = document.getElementById('input_phone');
      var editBtn = document.getElementById('editBtn');
      var uploadBtn = document.getElementById('uploadBtn');
      var removeAvatarBtn = document.getElementById('removeAvatarBtn');
      var avatarInput = document.getElementById('avatarInput');
      var logoutBtn = document.getElementById('logoutBtn');
      var logoutBtnTop = document.getElementById('logoutBtnTop');
      var logoutBtnMain = document.getElementById('logoutBtnMain');
      var editBtnTop = document.getElementById('editBtnTop');
      var toggleChangePw = document.getElementById('toggleChangePw');
      var changePwBox = document.getElementById('changePwBox');
      var changePwBtn = document.getElementById('changePwBtn');
      var cancelChangePw = document.getElementById('cancelChangePw');
      var currentPw = document.getElementById('currentPw');
      var newPw = document.getElementById('newPw');
      var confirmPw = document.getElementById('confirmPw');
      var deleteBtn = document.getElementById('deleteBtn');

      // wire floating fields for profile page now that inputs exist
      wireFloating(input_name); wireFloating(input_phone);
      // ensure avatar presentation
      if (p_avatar){
        p_avatar.style.borderRadius = '12px';
        p_avatar.style.objectFit = 'cover';
        p_avatar.style.width = '96px'; p_avatar.style.height = '96px';
      }

      var current = getCurrent();
      if (!current || !current.email) { window.location.href = 'index.html'; return; }

      // Find full user record (may contain password)
      var users = getUsers();
      var userIndex = users.findIndex(function(u){ return u.email && u.email.toLowerCase() === current.email.toLowerCase(); });
      var userRecord = userIndex >= 0 ? users[userIndex] : null;

      // Populate UI from either userRecord or current
      function renderFrom(rec){
        var r = rec || current || {};
        p_name.textContent = r.name || 'Profile';
        p_email.textContent = r.email || '';
        input_name.value = r.name || '';
        input_phone.value = r.phone || '';
        p_avatar.src = r.avatar || 'https://via.placeholder.com/96?text=Avatar';
        p_lastlogin.textContent = 'Last login: ' + (r.lastLogin ? new Date(r.lastLogin).toLocaleString() : 'Unknown');
        // update progress
        setProgress(computeCompletion(r, userRecord));
        // render activity
        renderActivity();
      }

      function hasCustomAvatar(r){
        var src = (r && r.avatar) || '';
        return !!src && src.indexOf('placeholder') === -1;
      }

      // Show / hide avatar-related controls
      function updateAvatarControls(){
        if (hasCustomAvatar(current)) removeAvatarBtn.classList.remove('hidden');
        else removeAvatarBtn.classList.add('hidden');
      }

      // Update last login to now and persist to both currentUser and users
      function touchLastLogin(){
        var now = new Date().toISOString();
        current.lastLogin = now;
        setCurrent(current);
        if (userIndex >= 0) { users[userIndex].lastLogin = now; saveUsers(users); }
        renderFrom(current);
        updateAvatarControls();
        pushActivity('Signed in (last login updated)');
      }

      renderFrom(userRecord || current);
      touchLastLogin();

      // Edit toggle
      var editing = false;
      editBtn.addEventListener('click', function(){
        if (!editing){
          editing = true;
          editBtn.textContent = 'Save';
          input_name.focus();
        } else {
          // save
          var newName = input_name.value.trim();
          var newPhone = input_phone.value.trim();
          if (!newName){ alert('Name cannot be empty'); return; }
          // button animation / disabled state
          editBtn.disabled = true;
          editBtn.textContent = 'Saving...';
          setTimeout(function(){ // simulate quick saving
            current.name = newName;
            current.phone = newPhone;
            setCurrent(current);
            if (userIndex >= 0){
              users[userIndex].name = newName;
              users[userIndex].phone = newPhone;
              saveUsers(users);
            }
            renderFrom(current);
            editing = false;
            editBtn.textContent = 'Edit';
            editBtn.disabled = false;
            showToast('Profile saved');
            pushActivity('Profile updated');
          }, 400);
        }
      });

      // Avatar upload
      // enable drag-drop on avatar
      ['dragenter','dragover'].forEach(function(ev){
        p_avatar.addEventListener(ev, function(e){ e.preventDefault(); p_avatar.classList.add('dragover'); avatarDrop.style.opacity = 1; });
      });
      ['dragleave','drop'].forEach(function(ev){
        p_avatar.addEventListener(ev, function(e){ p_avatar.classList.remove('dragover'); avatarDrop.style.opacity = 0; });
      });
      p_avatar.addEventListener('drop', function(e){
        e.preventDefault();
        var f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) || null;
        if (f) handleAvatarFile(f);
      });

       uploadBtn.addEventListener('click', function(){ avatarInput.click(); });
      avatarInput.addEventListener('change', function(e){
        var f = e.target.files && e.target.files[0];
        if (!f) return;
        handleAvatarFile(f);
      });
      function handleAvatarFile(f){
        var reader = new FileReader();
        reader.onload = function(ev){
          var data = ev.target.result;
          p_avatar.src = data;
          p_avatar.classList.add('pulse');
          setTimeout(function(){ p_avatar.classList.remove('pulse'); }, 650);
          current.avatar = data;
          setCurrent(current);
          if (userIndex >= 0){ users[userIndex].avatar = data; saveUsers(users); }
          setProgress(computeCompletion(current, userRecord));
          updateAvatarControls();
          showToast('Avatar updated');
          pushActivity('Avatar changed');
        };
        reader.readAsDataURL(f);
      }

      // Remove avatar logic
      removeAvatarBtn.addEventListener('click', function(){
        if (!hasCustomAvatar(current)) return;
        if (!confirm('Remove profile picture?')) return;
        // clear from current
        delete current.avatar;
        setCurrent(current);
        // clear from user record if persisted
        if (userIndex >= 0){
          delete users[userIndex].avatar;
          saveUsers(users);
        }
        // reset UI
        p_avatar.src = 'https://via.placeholder.com/96?text=Avatar';
        setProgress(computeCompletion(current, users[userIndex]));
        updateAvatarControls();
        showToast('Profile picture removed');
        pushActivity('Avatar removed');
      });

      // wire multiple logout buttons to same behavior
      function performLogout() {
        if (!confirm('Log out and return to sign-in page?')) return;
        logoutBtn.disabled = true;
        pushActivity('Logged out');
        localStorage.removeItem('currentUser');
        showToast('Logged out');
        document.body.classList.add('fade-out');
        setTimeout(function(){ window.location.href = 'index.html'; }, 550);
      }
      if (logoutBtn) logoutBtn.addEventListener('click', performLogout);
      if (logoutBtnTop) logoutBtnTop.addEventListener('click', performLogout);
      if (logoutBtnMain) logoutBtnMain.addEventListener('click', performLogout);

      // Change password toggle
      toggleChangePw.addEventListener('click', function(){
        changePwBox.classList.toggle('hidden');
      });
      cancelChangePw.addEventListener('click', function(){
        changePwBox.classList.add('hidden');
        currentPw.value = newPw.value = confirmPw.value = '';
      });

      // Change password logic
      changePwBtn.addEventListener('click', function(){
        if (!userRecord){ alert('Password change not available (no full account record).'); return; }
        var cur = currentPw.value || '';
        var nw = newPw.value || '';
        var cf = confirmPw.value || '';
        if (!cur || !nw || !cf){ alert('Fill all password fields'); return; }
        if (users[userIndex].password !== cur){ alert('Current password is incorrect'); return; }
        if (nw.length < 6){ alert('New password must be at least 6 characters'); return; }
        if (nw !== cf){ alert('New password and confirmation do not match'); return; }
        users[userIndex].password = nw;
        saveUsers(users);
        currentPw.value = newPw.value = confirmPw.value = '';
        changePwBox.classList.add('hidden');
        showToast('Password changed');
        setProgress(computeCompletion(current, users[userIndex]));
        pushActivity('Password changed');
      });

      // Delete account
      deleteBtn.addEventListener('click', function(){
        if (!confirm('Delete your account permanently? This cannot be undone.')) return;
        if (userIndex >= 0){
          users.splice(userIndex,1);
          saveUsers(users);
        }
        localStorage.removeItem('currentUser');
        pushActivity('Account deleted');
        showToast('Account deleted', 2200);
        window.location.href = 'index.html';
      });

      // show main top save button when editing
      editBtn.addEventListener('click', function(){
        if (editBtnTop) editBtnTop.classList.toggle('hidden', editBtn.textContent !== 'Save');
      });
    });
  })();
  </script>
</body>
</html>
