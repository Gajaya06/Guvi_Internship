<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Profile</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .profile-card { padding: 24px; max-width:480px; margin:40px auto; border-radius:8px; background:#fff; box-shadow:0 4px 16px rgba(0,0,0,0.06);}
    .profile-row { margin-bottom:12px; }
    .avatar { width:96px; height:96px; border-radius:50%; object-fit:cover; border:2px solid #eee; display:inline-block; vertical-align:middle; }
    .avatar-wrap { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .small-muted { color:#666; font-size:0.9rem; }
    .link-like { background:none; border:none; color:var(--accent,#0d6efd); padding:0; cursor:pointer; }
    .hidden { display:none; }
    .danger { background:#fff; border:1px solid #dc3545; color:#dc3545; }
  </style>
</head>
<body>
  <div class="profile-card">
    <div class="avatar-wrap">
      <img id="p_avatar" class="avatar" src="" alt="Avatar">
      <div>
        <h3 id="p_name">User</h3>
        <div class="small-muted" id="p_email">email@example.com</div>
        <div class="small-muted" id="p_lastlogin">Last login: -</div>
      </div>
    </div>

    <!-- Edit fields -->
    <div class="profile-row">
      <label>Name</label>
      <input id="input_name" class="form-control" type="text" />
    </div>
    <div class="profile-row">
      <label>Phone</label>
      <input id="input_phone" class="form-control" type="text" />
    </div>

    <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
      <button id="editBtn" class="btn btn-primary">Edit</button>
      <button id="uploadBtn" class="btn btn-secondary">Change avatar</button>
      <input id="avatarInput" type="file" accept="image/*" class="hidden" />
      <button id="logoutBtn" class="btn btn-outline-primary">Logout</button>
    </div>

    <hr>

    <!-- Change password -->
    <div>
      <button id="toggleChangePw" class="link-like">Change password</button>
      <div id="changePwBox" class="hidden" style="margin-top:8px;">
        <input id="currentPw" class="form-control" type="password" placeholder="Current password" />
        <input id="newPw" class="form-control" type="password" placeholder="New password (min 6 chars)" style="margin-top:8px;" />
        <input id="confirmPw" class="form-control" type="password" placeholder="Confirm new password" style="margin-top:8px;" />
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="changePwBtn" class="btn btn-success">Save password</button>
          <button id="cancelChangePw" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <hr>

    <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
      <div class="small-muted">Account actions</div>
      <button id="deleteBtn" class="btn danger">Delete account</button>
    </div>
  </div>

  <script>
  (function(){
    function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
    function getUsers(){ try{ return JSON.parse(localStorage.getItem('users')||'[]'); } catch(e){ return []; } }
    function saveUsers(u){ localStorage.setItem('users', JSON.stringify(u)); }
    function getCurrent(){ try{ return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch(e){ return null; } }
    function setCurrent(u){ localStorage.setItem('currentUser', JSON.stringify(u)); }

    ready(function(){
      var p_avatar = document.getElementById('p_avatar');
      var p_name = document.getElementById('p_name');
      var p_email = document.getElementById('p_email');
      var p_lastlogin = document.getElementById('p_lastlogin');
      var input_name = document.getElementById('input_name');
      var input_phone = document.getElementById('input_phone');
      var editBtn = document.getElementById('editBtn');
      var uploadBtn = document.getElementById('uploadBtn');
      var avatarInput = document.getElementById('avatarInput');
      var logoutBtn = document.getElementById('logoutBtn');
      var toggleChangePw = document.getElementById('toggleChangePw');
      var changePwBox = document.getElementById('changePwBox');
      var changePwBtn = document.getElementById('changePwBtn');
      var cancelChangePw = document.getElementById('cancelChangePw');
      var currentPw = document.getElementById('currentPw');
      var newPw = document.getElementById('newPw');
      var confirmPw = document.getElementById('confirmPw');
      var deleteBtn = document.getElementById('deleteBtn');

      var current = getCurrent();
      if (!current || !current.email) { window.location.href = 'index.html'; return; }

      // Find full user record (may contain password)
      var users = getUsers();
      var userIndex = users.findIndex(function(u){ return u.email && u.email.toLowerCase() === current.email.toLowerCase(); });
      var userRecord = userIndex >= 0 ? users[userIndex] : null;

      // Populate UI from either userRecord or current
      function renderFrom(rec){
        var r = rec || current || {};
        p_name.textContent = r.name || 'Profile';
        p_email.textContent = r.email || '';
        input_name.value = r.name || '';
        input_phone.value = r.phone || '';
        p_avatar.src = r.avatar || 'https://via.placeholder.com/96?text=Avatar';
        p_lastlogin.textContent = 'Last login: ' + (r.lastLogin ? new Date(r.lastLogin).toLocaleString() : 'Unknown');
      }

      // Update last login to now and persist to both currentUser and users
      function touchLastLogin(){
        var now = new Date().toISOString();
        current.lastLogin = now;
        setCurrent(current);
        if (userIndex >= 0) { users[userIndex].lastLogin = now; saveUsers(users); }
        renderFrom(current);
      }

      renderFrom(userRecord || current);
      touchLastLogin();

      // Edit toggle
      var editing = false;
      editBtn.addEventListener('click', function(){
        if (!editing){
          editing = true;
          editBtn.textContent = 'Save';
          input_name.focus();
        } else {
          // save
          var newName = input_name.value.trim();
          var newPhone = input_phone.value.trim();
          if (!newName){ alert('Name cannot be empty'); return; }
          current.name = newName;
          current.phone = newPhone;
          setCurrent(current);
          if (userIndex >= 0){
            users[userIndex].name = newName;
            users[userIndex].phone = newPhone;
            saveUsers(users);
          }
          renderFrom(current);
          editing = false;
          editBtn.textContent = 'Edit';
          alert('Profile saved');
        }
      });

      // Avatar upload
      uploadBtn.addEventListener('click', function(){ avatarInput.click(); });
      avatarInput.addEventListener('change', function(e){
        var f = e.target.files && e.target.files[0];
        if (!f) return;
        var reader = new FileReader();
        reader.onload = function(ev){
          var data = ev.target.result;
          p_avatar.src = data;
          current.avatar = data;
          setCurrent(current);
          if (userIndex >= 0){ users[userIndex].avatar = data; saveUsers(users); }
          alert('Avatar updated');
        };
        reader.readAsDataURL(f);
      });

      // Logout
      logoutBtn.addEventListener('click', function(){
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      });

      // Change password toggle
      toggleChangePw.addEventListener('click', function(){
        changePwBox.classList.toggle('hidden');
      });
      cancelChangePw.addEventListener('click', function(){
        changePwBox.classList.add('hidden');
        currentPw.value = newPw.value = confirmPw.value = '';
      });

      // Change password logic
      changePwBtn.addEventListener('click', function(){
        if (!userRecord){ alert('Password change not available (no full account record).'); return; }
        var cur = currentPw.value || '';
        var nw = newPw.value || '';
        var cf = confirmPw.value || '';
        if (!cur || !nw || !cf){ alert('Fill all password fields'); return; }
        if (users[userIndex].password !== cur){ alert('Current password is incorrect'); return; }
        if (nw.length < 6){ alert('New password must be at least 6 characters'); return; }
        if (nw !== cf){ alert('New password and confirmation do not match'); return; }
        users[userIndex].password = nw;
        saveUsers(users);
        currentPw.value = newPw.value = confirmPw.value = '';
        changePwBox.classList.add('hidden');
        alert('Password changed');
      });

      // Delete account
      deleteBtn.addEventListener('click', function(){
        if (!confirm('Delete your account permanently? This cannot be undone.')) return;
        if (userIndex >= 0){
          users.splice(userIndex,1);
          saveUsers(users);
        }
        localStorage.removeItem('currentUser');
        alert('Account deleted');
        window.location.href = 'index.html';
      });
    });
  })();
  </script>
</body>
</html>
